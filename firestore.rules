rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow users to read and write their own user profile document
    // This is essential for storing legal consent and other user-level preferences
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Users can only read/write their own pantry items
    match /users/{userId}/pantry/{itemId} {
      allow read, write, delete: if request.auth.uid == userId;
    }

    // Users can read/write their own shopping list
    match /users/{userId}/shoppingList/{itemId} {
      allow read, write, delete: if request.auth.uid == userId;
    }

    // Legacy path support (if needed)
    match /pantry/{userId}/{pantryId} {
      allow read, write, delete: if request.auth.uid == userId;
    }

    // Users can only read/write their own saved recipes (Legacy)
    match /users/{userId}/savedRecipes/{recipeId} {
      allow read, write, delete: if request.auth.uid == userId;
    }

    // Users can read/write their own recipe collections (Favorites, Cooked, Want to Try)
    match /users/{userId}/recipeCollections/{collectionId} {
      allow read, write, delete: if request.auth.uid == userId;
    }

    // Users can read/write their own recipe ratings
    match /users/{userId}/recipeRatings/{ratingId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Allow users to create recipe requests (for job-based generation)
    match /users/{userId}/recipe_requests/{requestId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Usage data: users can read their own, but only cloud functions can write/update it
    match /users/{userId}/usage/current {
      allow read: if request.auth.uid == userId;
      allow write: if false; // Prevent client-side writes
    }

    // Gift codes: Authenticated users can read, but only cloud functions can write
    match /giftCodes/{code} {
      allow read: if request.auth != null;
      allow write: if false; // Prevent client-side writes
    }

    // Households: Members can read household data
    match /households/{householdId} {
      allow read: if request.auth.uid in resource.data.memberIds;
      allow write: if false; // Only cloud functions can write
    }

    // Household pantry items: Members can read/write/delete
    match /households/{householdId}/pantry/{itemId} {
      allow read, write, delete: if request.auth.uid in 
        get(/databases/$(database)/documents/households/$(householdId)).data.memberIds;
    }

    // Household shopping list: Members can read/write/delete
    match /households/{householdId}/shoppingList/{itemId} {
      allow read, write, delete: if request.auth.uid in 
        get(/databases/$(database)/documents/households/$(householdId)).data.memberIds;
    }

    // Household usage quota: Members can read, only cloud functions can write
    match /households/{householdId}/usage/current {
      allow read: if request.auth.uid in 
        get(/databases/$(database)/documents/households/$(householdId)).data.memberIds;
      allow write: if false; // Cloud functions only
    }
  }
}
